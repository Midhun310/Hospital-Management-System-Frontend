<mat-toolbar color="primary">
  <span>Receptionist Dashboard!!!</span>
  <span class="spacer">
    <button class=" delete" mat-button (click)="logout()">Logout
      <mat-icon>logout</mat-icon>
    </button>
  </span>
</mat-toolbar>

<div class="dashboard-container">
  <mat-card class="dashboard-card" (click)="openAddPatientForm(addpatient)">
    <mat-card-title>New Patients</mat-card-title>
  </mat-card>

  <mat-card class="dashboard-card" (click)="openPatientTable()">
    <mat-card-title>View Patients</mat-card-title>
  </mat-card>

  <mat-card class="dashboard-card" (click)="openBookAppointment()">
    <mat-card-title>Book Appointments</mat-card-title>
  </mat-card>

  <mat-card class="dashboard-card" (click)="openViewAppointments()">
    <mat-card-title>View Appointments</mat-card-title>
  </mat-card>
</div>

<!-- patient table -->
<ng-template #addpatient>
  <h3>Add New Patient</h3>
  <form #addForm="ngForm" (ngSubmit)="addPatient()">
       <mat-card-content>
      <form #form="ngForm" class="form-grid">
        <div class="form-row"
          *ngFor="let field of ['name', 'mobile', 'age', 'gender', 'address', 'patientSymptoms', 'visit']">
          <mat-form-field  appearance="outline">
            <mat-label>{{ field | titlecase }}</mat-label>
            <ng-container [ngSwitch]="field">
              <input *ngSwitchCase="'name'" matInput [(ngModel)]="newPatient.name" name="name">
              <input *ngSwitchCase="'mobile'" matInput [(ngModel)]="newPatient.mobile" name="mobile">
              <input *ngSwitchCase="'age'" matInput [(ngModel)]="newPatient.age" name="age">

              <mat-select *ngSwitchCase="'gender'" [(ngModel)]="newPatient.gender" name="gender">
                <mat-option value="Male">Male</mat-option>
                <mat-option value="Female">Female</mat-option>
                <mat-option value="Other">Other</mat-option>
              </mat-select>

              <input *ngSwitchCase="'address'" matInput [(ngModel)]="newPatient.address" name="address">
              <input *ngSwitchCase="'patientSymptoms'" matInput [(ngModel)]="newPatient.patientSymptoms"
                name="patientSymptoms">

              <mat-select *ngSwitchCase="'visit'" [(ngModel)]="newPatient.visit" name="visit">
                <mat-option value="New">New</mat-option>
                <mat-option value="Follow-up">Follow-up</mat-option>
                <mat-option value="Emergency">Emergency</mat-option>
              </mat-select>
            </ng-container>
          </mat-form-field>
        </div>
      </form>
    </mat-card-content>

    <div class="submit">
      <button class="cancel" mat-button type="button" (click)="cancel()"> Cancel </button>
      <button class="save" mat-button type="submit">Save</button>
    </div>
  </form>
</ng-template>

<!-- patients table -->
<div *ngIf="showPatientTable" class="patient-details">
  <h2>Patient Details</h2>
  <table mat-table [dataSource]="patients" class="mat-elevation-z8">
    <ng-container matColumnDef="sno">
      <th mat-header-cell *matHeaderCellDef>S.No</th>
      <td mat-cell *matCellDef="let element; let i = index">{{patientPage * patientLimit + i + 1 }}</td>
    </ng-container>

    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Name</th>
      <td mat-cell *matCellDef="let r">{{ r.name }}</td>
    </ng-container>

    <ng-container matColumnDef="mobile">
      <th mat-header-cell *matHeaderCellDef>Mobile</th>
      <td mat-cell *matCellDef="let r">{{ r.mobile }}</td>
    </ng-container>

    <ng-container matColumnDef="age">
      <th mat-header-cell *matHeaderCellDef>Age</th>
      <td mat-cell *matCellDef="let r">{{ r.age }}</td>
    </ng-container>

    <ng-container matColumnDef="gender">
      <th mat-header-cell *matHeaderCellDef>Gender</th>
      <td mat-cell *matCellDef="let r">{{ r.gender }}</td>
    </ng-container>

    <ng-container matColumnDef="patientSymptoms">
      <th mat-header-cell *matHeaderCellDef>Symptoms</th>
      <td mat-cell *matCellDef="let r">{{ r.patientSymptoms }}</td>
    </ng-container>

    <ng-container matColumnDef="visit">
      <th mat-header-cell *matHeaderCellDef>Visit</th>
      <td mat-cell *matCellDef="let r">{{ r.visit }}</td>
    </ng-container>

    <ng-container matColumnDef="report">
      <th mat-header-cell *matHeaderCellDef>Report</th>
      <td mat-cell *matCellDef="let patient">
        <button mat-button (click)="toggleUploadForm(patient._id)">
          Upload
        </button>

        <div *ngIf="uploadingPatientId === patient._id">
          <input type="file" (change)="onReportFileChange($event)">
          <button mat-raised-button color="primary" (click)="uploadReport(patient._id)"> Submit </button>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="file">
      <th mat-header-cell *matHeaderCellDef>File</th>
      <td mat-cell *matCellDef="let r">
        <ng-container *ngIf="r.medicalReportFile">
          <button mat-button color="accent" (click)="download(r.medicalReportFile)">
            Download
          </button>
        </ng-container>
        <ng-container *ngIf="!r.medicalReportFile">
          <span>No Report</span>
        </ng-container>
      </td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let patient">
        <button class="edit" mat-button (click)="editPatient(patient, editpatientRef)">Edit</button>
      </td>
    </ng-container>

    <tr mat-header-row
      *matHeaderRowDef="['sno', 'name', 'mobile', 'age', 'gender', 'patientSymptoms', 'visit', 'report', 'file','actions']">
    </tr>
    <tr mat-row
      *matRowDef="let row;columns: ['sno', 'name', 'mobile', 'age', 'gender', 'patientSymptoms', 'visit', 'report', 'file', 'actions']">
    </tr>
  </table>
  <mat-paginator [length]="totalPatientCount" [pageSize]="patientLimit" [pageSizeOptions]="[10, 25, 50, 100]"
    (page)="onPagePatientChange($event)" showFirstLastButtons></mat-paginator>

</div>



<!-- edit form -->
<ng-template #editpatientRef>
  <div *ngIf="editingPatient">
    <h3>Edit Patient</h3>
    <form #editForm="ngForm" (ngSubmit)="updatePatient()">
      <mat-form-field  appearance="outline">
        <mat-label>Name</mat-label>
        <input matInput [(ngModel)]="editingPatient.name" name="name" required>
      </mat-form-field>

      <mat-form-field  appearance="outline">
        <mat-label>Mobile</mat-label>
        <input matInput [(ngModel)]="editingPatient.mobile" name="mobile" required>
      </mat-form-field>

      <mat-form-field  appearance="outline">
        <mat-label>Age</mat-label>
        <input matInput [(ngModel)]="editingPatient.age" name="age" type="number" required>
      </mat-form-field>

      <mat-form-field  appearance="outline">
        <mat-label>Gender</mat-label>
        <mat-select [(ngModel)]="editingPatient.gender" name="gender" required>
          <mat-option value="Male">Male</mat-option>
          <mat-option value="Female">Female</mat-option>
          <mat-option value="Other">Other</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field  appearance="outline">
        <mat-label>Address</mat-label>
        <input matInput [(ngModel)]="editingPatient.address" name="address" required>
      </mat-form-field>

      <mat-form-field  appearance="outline">
        <mat-label>Symptoms</mat-label>
        <input matInput [(ngModel)]="editingPatient.patientSymptoms" name="patientSymptoms" required>
      </mat-form-field>

      <mat-form-field  appearance="outline">
        <mat-label>Visit</mat-label>
        <mat-select [(ngModel)]="editingPatient.visit" name="visit" required>
          <mat-option value="New">New</mat-option>
          <mat-option value="Follow-up">Follow-up</mat-option>
          <mat-option value="Emergency">Emergency</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="submit">
        <button class="cancel" mat-button color="warn" type="button" (click)="cancelEdit()">Cancel</button>
        <button class="update" mat-button color="primary" type="submit">Update</button>
      </div>
    </form>
  </div>
</ng-template>

<!-- book appointment -->
<div *ngIf="!isTable">
  <div *ngIf="showBookingTable" class="booking-table">
    <h2>Book Appointment</h2>
    <table mat-table [dataSource]="patients" class="mat-elevation-z8">
      <ng-container matColumnDef="sno">
        <th mat-header-cell *matHeaderCellDef>S.No</th>
        <!-- <td mat-cell *matCellDef="let element; let i = index">{{ i + 1 }}</td> -->
        <td mat-cell *matCellDef="let element; let i = index">{{patientPage * patientLimit + i + 1 }}</td>

      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Name</th>
        <td mat-cell *matCellDef="let patient">{{ patient.name }}</td>
      </ng-container>

      <ng-container matColumnDef="mobile">
        <th mat-header-cell *matHeaderCellDef>Mobile</th>
        <td mat-cell *matCellDef="let patient">{{ patient.mobile }}</td>
      </ng-container>

      <ng-container matColumnDef="age">
        <th mat-header-cell *matHeaderCellDef>Age</th>
        <td mat-cell *matCellDef="let patient">{{ patient.age }}</td>
      </ng-container>

      <ng-container matColumnDef="gender">
        <th mat-header-cell *matHeaderCellDef>Gender</th>
        <td mat-cell *matCellDef="let patient">{{ patient.gender }}</td>
      </ng-container>

      <ng-container matColumnDef="patientSymptoms">
        <th mat-header-cell *matHeaderCellDef>Symptoms</th>
        <td mat-cell *matCellDef="let patient">
          {{ patient.patientSymptoms }}
        </td>
      </ng-container>

      <ng-container matColumnDef="visit">
        <th mat-header-cell *matHeaderCellDef>Visit</th>
        <td mat-cell *matCellDef="let patient">{{ patient.visit }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Action</th>
        <td mat-cell *matCellDef="let patient">
          <button class="edit" mat-button (click)="selectPatient(patient)">Book</button>
        </td>
      </ng-container>

      <tr mat-header-row
        *matHeaderRowDef="['sno', 'name', 'mobile', 'age', 'gender', 'patientSymptoms', 'visit', 'actions']"></tr>
      <tr mat-row *matRowDef="
          let row;
          columns: [ 'sno', 'name', 'mobile', 'age', 'gender', 'patientSymptoms',
            'visit',
            'actions'
          ]
        "></tr>
    </table>
    <mat-paginator [length]="totalPatientCount" [pageSize]="patientLimit" [pageSizeOptions]="[10, 25, 50, 100]"
      (page)="onPagePatientChange($event)" showFirstLastButtons></mat-paginator>

  </div>
</div>

<!-- doctor list -->
<div *ngIf="isTable">
  <div *ngIf="showDoctorList && selectedPatientForBooking">
    <h2>Select Doctor for: {{ selectedPatientForBooking.name }}</h2>
    <!-- <table mat-table [dataSource]="dataSource" class="mat-elevation-z8"> -->


    <div *ngIf="doctors.length > 0; else noDoctorsFound">
      <table mat-table [dataSource]="doctors" class="mat-elevation-z8">
        <ng-container matColumnDef="sno">
          <th mat-header-cell *matHeaderCellDef>S.No</th>
          <td mat-cell *matCellDef="let element; let i = index">{{page * limit + i + 1 }}</td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Name</th>
          <td mat-cell *matCellDef="let doctor">{{ doctor.name }}</td>
        </ng-container>

        <ng-container matColumnDef="department">
          <th mat-header-cell *matHeaderCellDef>Department</th>
          <td mat-cell *matCellDef="let doctor">{{ doctor.department }}</td>
        </ng-container>

        <ng-container matColumnDef="shift">
          <th mat-header-cell *matHeaderCellDef>Shift</th>
          <td mat-cell *matCellDef="let doctor">{{ doctor.shift }}</td>
        </ng-container>

        <ng-container matColumnDef="workStatus">
          <th mat-header-cell *matHeaderCellDef>Work Status</th>
          <td mat-cell *matCellDef="let doctor">{{ doctor.workStatus }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let doctor">
            <button class="update" mat-button (click)="addBtnDoctor(booking, doctor)">
              Select
            </button>
          </td>
        </ng-container>

        <!-- header & row -->
        <tr mat-header-row *matHeaderRowDef="[
            'sno',
            'name',
            'department',
            'shift',
            'workStatus',
            'actions'
          ]"></tr>
        <tr mat-row *matRowDef="
            let row;
            columns: [
              'sno',
              'name',
              'department',
              'shift',
              'workStatus',
              'actions'
            ]
          "></tr>
      </table>
      <mat-paginator [length]="totalDoctorCount" [pageSize]="limit"  [pageSizeOptions]="[10, 25, 50, 100]" (page)="onPageChange($event)" showFirstLastButtons></mat-paginator>

    </div>
    <ng-template #noDoctorsFound>
      <p>No active doctors available.</p>
    </ng-template>


    <!-- appointment form -->
    <ng-template #booking>
      <h3 *ngIf="selectedDoctor">
        Booking Appointment with {{ selectedDoctor.name }}
      </h3>
      <form #bookingForm="ngForm">
        <div class="date">
          <mat-form-field  appearance="outline">
            <mat-label>Choose a date</mat-label>
            <input matInput [matDatepicker]="picker" [(ngModel)]="bookingDate" name="bookingDate" required />

            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="date">
          <mat-form-field  appearance="outline">
            <mat-label>Time</mat-label>
            <input matInput type="time" [(ngModel)]="bookingTime" name="bookingTime" required />
          </mat-form-field>
        </div>

        <div class="submit">
          <button class="cancel" mat-button color="warn" type="button" (click)="cancelEdit()">
            Cancel
          </button>
          <button class="update" mat-button type="submit" (click)="confirmBooking()">
            Book Appointment
          </button>
        </div>
      </form>
    </ng-template>
    <!-- </table> -->
  </div>
</div>

<!-- appointments table -->
<div *ngIf="showAppointmentTable" class="appointment-table">
  <h2>Appointments</h2>
  <table mat-table [dataSource]="appointments" class="mat-elevation-z8">
    <ng-container matColumnDef="sno">
      <th mat-header-cell *matHeaderCellDef>S.No</th>
      <td mat-cell *matCellDef="let element; let i = index">{{appointmentsPage * appointmentsLimit + i + 1 }}</td>

      <td mat-cell *matCellDef="let row; let i = index">{{ i + 1 }}</td>
    </ng-container>

    <ng-container matColumnDef="patient">
      <th mat-header-cell *matHeaderCellDef>Patient Name</th>
      <td mat-cell *matCellDef="let row">
        {{ row.patient?.name || row.patientName }}
      </td>
    </ng-container>

    <ng-container matColumnDef="doctor">
      <th mat-header-cell *matHeaderCellDef>Doctor Name</th>
      <td mat-cell *matCellDef="let row">
        {{ row.doctor?.name || row.doctorName }}
      </td>
    </ng-container>

    <ng-container matColumnDef="date">
      <th mat-header-cell *matHeaderCellDef>Date</th>
      <td mat-cell *matCellDef="let row">
        {{ row.appointment?.date | date : "shortDate" }}
      </td>
    </ng-container>

    <ng-container matColumnDef="time">
      <th mat-header-cell *matHeaderCellDef>Time</th>
      <td mat-cell *matCellDef="let row">{{ row.appointment?.time }}</td>
    </ng-container>

    <ng-container matColumnDef="actions">
      <th mat-header-cell *matHeaderCellDef>Actions</th>
      <td mat-cell *matCellDef="let row">
        <button class="edit" mat-button (click)="editAppointment(row, editappointmentRef)">
          Edit
        </button>
      </td>
    </ng-container>

    <ng-container matColumnDef="status">
      <th mat-header-cell *matHeaderCellDef>Status</th>
      <td mat-cell *matCellDef="let row">
        {{ row.appointment?.status || "scheduled" }}
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="[
        'sno',
        'patient',
        'doctor',
        'date',
        'time',
        'status',
        'actions'
      ]"></tr>
    <tr mat-row *matRowDef="
        let row;
        columns: [
          'sno',
          'patient',
          'doctor',
          'date',
          'time',
          'status',
          'actions'
        ]
      "></tr>
  </table>
  <mat-paginator [length]="totalAppointmentsCount" [pageSize]="appointmentsLimit" [pageSizeOptions]="[10, 25, 50, 100]"
    (page)="onPageAppointmentChange($event)" showFirstLastButtons></mat-paginator>


  <!-- Edit Appointment Form -->
  <ng-template #editappointmentRef class="dialog">
    <div *ngIf="editingAppointment">
      <h3>
        Edit Appointment for:{{
        editingAppointment.patient?.name || editingAppointment.patientName
        }}
      </h3>

      <form (ngSubmit)="updateAppointment()" #editAppForm="ngForm">
        <mat-form-field  appearance="outline">
          <mat-label>Patient</mat-label>
          <mat-select [(ngModel)]="editingAppointment.patientId" name="patientId" required>
            <mat-option *ngFor="let p of patients" [value]="p._id">{{
              p.name
              }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field  appearance="outline">
          <mat-label>Doctor</mat-label>
          <mat-select [(ngModel)]="editingAppointment.doctorId" name="doctorId" required>
            <mat-option *ngFor="let d of doctors" [value]="d._id">{{
              d.name
              }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field  appearance="outline">
          <mat-label>Date</mat-label>
          <input matInput type="date" [(ngModel)]="editingAppointment.date" name="date" required />
        </mat-form-field>

        <mat-form-field  appearance="outline">
          <mat-label>Time</mat-label>
          <input matInput type="time" [(ngModel)]="editingAppointment.time" name="time" required />
        </mat-form-field>

        <mat-form-field  appearance="outline">
          <mat-label>Status</mat-label>
          <mat-select [(ngModel)]="editingAppointment.status" name="status" required>
            <mat-option value="scheduled">Scheduled</mat-option>
            <mat-option value="completed">Completed</mat-option>
            <mat-option value="cancelled">Cancelled</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="submit">
          <button class="cancel" mat-button type="button" (click)="cancelEditappointment()">
            Cancel
          </button>
          <button class="update" mat-button type="submit">Update</button>
        </div>
      </form>
    </div>
  </ng-template>
</div>